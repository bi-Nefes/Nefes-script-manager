{% extends "base.html" %}

{% block title %}Dashboard - Script Manager{% endblock %}

{% block content %}
<div class="dashboard-container">
  <!-- Top Navigation Bar -->
  <div class="top-nav">
    <div class="container-fluid">
      <div class="row align-items-center">
        <div class="col-md-6">
          <div class="welcome-section">
            <h2 class="welcome-text">
              <i class="fas fa-terminal me-2"></i>
              Hoşgeldiniz
            </h2>
            <p class="welcome-subtitle">
              <i class="fas fa-user me-1"></i>{{ current_user.username }} 
              <span class="separator">•</span> 
              <i class="fas fa-clock me-1"></i>{{ current_time }}
              <span class="separator">•</span> 
              <i class="fas fa-shield-alt me-1"></i>{{ current_user.role_display_name }}
            </p>
          </div>
        </div>
        <div class="col-md-6 text-end">
          <div class="quick-actions">
            <a href="{{ url_for('run_script') }}" class="btn btn-primary btn-sm me-2">
              <i class="fas fa-play me-1"></i>Script Çalıştır
            </a>
            <a href="{{ url_for('servers') }}" class="btn btn-primary btn-sm me-2">
              <i class="fas fa-server me-1"></i>Sunucular
            </a>
            <a href="{{ url_for('scripts') }}" class="btn btn-primary btn-sm">
              <i class="fas fa-code me-1"></i>Scriptler
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Dashboard Content -->
  <div class="container-fluid py-4">
    
    <!-- Key Metrics Row -->
    <div class="row mb-4">
      <div class="col-xl-3 col-lg-6 col-md-6 mb-3">
        <div class="metric-card primary-gradient">
          <div class="metric-icon">
            <i class="fas fa-server"></i>
          </div>
          <div class="metric-content">
            <div class="metric-number">{{ servers|length }}</div>
            <div class="metric-label">Aktif Sunucu</div>
            <div class="metric-trend">
              <i class="fas fa-arrow-up text-success"></i>
              <span class="text-success">+{{ servers|length }}</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-xl-3 col-lg-6 col-md-6 mb-3">
        <div class="metric-card success-gradient">
          <div class="metric-icon">
            <i class="fas fa-code"></i>
          </div>
          <div class="metric-content">
            <div class="metric-number">{{ scripts|length }}</div>
            <div class="metric-label">Toplam Script</div>
            <div class="metric-trend">
              <i class="fas fa-arrow-up text-success"></i>
              <span class="text-success">+{{ scripts|length }}</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-xl-3 col-lg-6 col-md-6 mb-3">
        <div class="metric-card warning-gradient">
          <div class="metric-icon">
            <i class="fas fa-clock"></i>
          </div>
          <div class="metric-content">
            <div class="metric-number">{{ tasks|length }}</div>
            <div class="metric-label">Zamanlanmış Görev</div>
            <div class="metric-trend">
              <i class="fas fa-clock text-warning"></i>
              <span class="text-warning">{{ today_tasks|length }} bugün</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-xl-3 col-lg-6 col-md-6 mb-3">
        <div class="metric-card info-gradient">
          <div class="metric-icon">
            <i class="fas fa-chart-line"></i>
          </div>
          <div class="metric-content">
            <div class="metric-number">{{ logs|length }}</div>
            <div class="metric-label">Toplam Log</div>
            <div class="metric-trend">
              <i class="fas fa-arrow-up text-info"></i>
              <span class="text-info">+{{ logs|length }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content Row -->
    <div class="row">
      <!-- Left Column -->
      <div class="col-xl-8 col-lg-7 mb-4">
        
        <!-- Activity Chart -->
        <div class="dashboard-card">
          <div class="card-header">
            <h5 class="card-title">
              <i class="fas fa-chart-area me-2"></i>
              Son 7 Gün Aktivite Grafiği
            </h5>
            <div class="card-actions">
              <button class="btn btn-sm btn-outline-primary" onclick="refreshChart()">
                <i class="fas fa-sync-alt"></i>
              </button>
            </div>
          </div>
          <div class="card-body">
            <canvas id="activityChart" height="100"></canvas>
          </div>
        </div>

        <!-- Recent Activities -->
        <div class="dashboard-card">
          <div class="card-header">
            <h5 class="card-title">
              <i class="fas fa-history me-2"></i>
              Son Aktiviteler
            </h5>
            <a href="{{ url_for('logs') }}" class="btn btn-sm btn-outline-primary">
              Tümünü Gör
            </a>
          </div>
          <div class="card-body p-0">
            <div class="activity-list">
              {% for log in recent_logs %}
              <div class="activity-item">
                <div class="activity-icon">
                  {% if log.status == 'success' %}
                    <div class="icon-bg success">
                      <i class="fas fa-check"></i>
                    </div>
                  {% elif log.status == 'error' %}
                    <div class="icon-bg danger">
                      <i class="fas fa-times"></i>
                    </div>
                  {% elif log.status == 'started' %}
                    <div class="icon-bg warning">
                      <i class="fas fa-play"></i>
                    </div>
                  {% elif log.status == 'timeout' %}
                    <div class="icon-bg warning">
                      <i class="fas fa-clock"></i>
                    </div>
                  {% else %}
                    <div class="icon-bg secondary">
                      <i class="fas fa-question"></i>
                    </div>
                  {% endif %}
                </div>
                <div class="activity-content">
                  <div class="activity-title">
                    <strong>{{ log.script.name if log.script else 'Bilinmeyen Script' }}</strong>
                    <span class="activity-status">
                      {% if log.status == 'started' %}
                        <span class="badge bg-warning bg-opacity-75">Başlatıldı</span>
                      {% elif log.status == 'timeout' %}
                        <span class="badge bg-warning bg-opacity-75">Timeout</span>
                      {% endif %}
                    </span>
                  </div>
                  <div class="activity-details">
                    {{ log.server.name if log.server else 'Bilinmeyen Sunucu' }} • {{ log.timestamp|time_ago }}
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>

      </div>

      <!-- Right Column -->
      <div class="col-xl-4 col-lg-5 mb-4">
        
        <!-- Quick Stats -->
        <div class="dashboard-card">
          <div class="card-header">
            <h5 class="card-title">
              <i class="fas fa-tachometer-alt me-2"></i>
              Hızlı İstatistikler
            </h5>
          </div>
          <div class="card-body">
            <div class="quick-stats">
              <div class="stat-item">
                <div class="stat-icon bg-primary">
                  <i class="fas fa-calendar-check"></i>
                </div>
                <div class="stat-info">
                  <div class="stat-value">{{ today_tasks|length }}</div>
                  <div class="stat-label">Bugün Çalışacak</div>
                </div>
              </div>
              
              <div class="stat-item">
                <div class="stat-icon bg-success">
                  <i class="fas fa-fire"></i>
                </div>
                <div class="stat-info">
                  <div class="stat-value">{{ popular_scripts[0].usage_count if popular_scripts else 0 }}</div>
                  <div class="stat-label">En Popüler Script</div>
                </div>
              </div>
              
              <div class="stat-item">
                <div class="stat-icon bg-warning">
                  <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="stat-info">
                  <div class="stat-value">{{ logs|selectattr('status', 'equalto', 'error')|list|length }}</div>
                  <div class="stat-label">Hata Sayısı</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Popular Scripts -->
        <div class="dashboard-card">
          <div class="card-header">
            <h5 class="card-title">
              <i class="fas fa-star me-2"></i>
              Popüler Scriptler
            </h5>
          </div>
          <div class="card-body p-0">
            <div class="popular-scripts">
              {% for script in popular_scripts[:5] %}
              <div class="script-item">
                <div class="script-icon">
                  <i class="fas fa-code"></i>
                </div>
                <div class="script-info">
                  <div class="script-name">{{ script.name }}</div>
                  <div class="script-usage">{{ script.usage_count }} kez kullanıldı</div>
                </div>
                <div class="script-actions">
                  <a href="{{ url_for('run_script') }}?script_id={{ script.id }}" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-play"></i>
                  </a>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>

        <!-- Today's Tasks -->
        <div class="dashboard-card">
          <div class="card-header">
            <h5 class="card-title">
              <i class="fas fa-calendar-day me-2"></i>
              Bugün Çalışacak Görevler
            </h5>
          </div>
          <div class="card-body p-0">
            <div class="today-tasks">
              {% if today_tasks %}
                {% for task_info in today_tasks[:3] %}
                <div class="task-item">
                  <div class="task-time">{{ task_info.time_str }}</div>
                  <div class="task-info">
                    <div class="task-name">{{ task_info.task.name }}</div>
                    <div class="task-details">{{ task_info.task.server.name }} • {{ task_info.task.script.name }}</div>
                  </div>
                </div>
                {% endfor %}
                {% if today_tasks|length > 3 %}
                <div class="task-more">
                  <a href="{{ url_for('scheduler') }}" class="text-primary">
                    +{{ today_tasks|length - 3 }} görev daha...
                  </a>
                </div>
                {% endif %}
              {% else %}
                <div class="no-tasks">
                  <i class="fas fa-calendar-times text-muted"></i>
                  <p class="text-muted mb-0">Bugün çalışacak görev yok</p>
                </div>
              {% endif %}
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Bottom Row -->
    <div class="row">
      <div class="col-12">
        <div class="dashboard-card">
          <div class="card-header">
            <h5 class="card-title">
              <i class="fas fa-chart-pie me-2"></i>
              Sistem Dağılımı
            </h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <canvas id="serverUsageChart" height="200"></canvas>
              </div>
              <div class="col-md-6">
                <canvas id="scriptTypesChart" height="200"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<style>
.dashboard-container {
  background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f1f5f9 100%);
  min-height: 100vh;
}

/* Top Navigation */
.top-nav {
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  color: white;
  padding: 1.5rem 0;
  margin-bottom: 2rem;
  box-shadow: var(--shadow-lg);
}

.welcome-text {
  font-size: 1.8rem;
  font-weight: 700;
  margin: 0;
  text-shadow: 0 2px 4px rgba(0,0,0,0.1);
  color: white;
}

.welcome-subtitle {
  margin: 0.5rem 0 0 0;
  opacity: 0.9;
  font-size: 1rem;
  color: white;
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.separator {
  opacity: 0.6;
  margin: 0 0.25rem;
}

.welcome-subtitle i {
  margin-right: 0.25rem;
  opacity: 0.8;
}

.quick-actions .btn {
  border-radius: var(--radius-lg);
  font-weight: 500;
  padding: 0.5rem 1rem;
}

/* Metric Cards */
.metric-card {
  background: white;
  border-radius: var(--radius-xl);
  padding: 1.5rem;
  box-shadow: var(--shadow-lg);
  position: relative;
  overflow: hidden;
  transition: all 0.3s ease;
  border: none;
}

.metric-card:hover {
  transform: translateY(-5px);
  box-shadow: var(--shadow-2xl);
}

.metric-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--primary), var(--primary-light));
}

.primary-gradient::before { background: linear-gradient(90deg, var(--primary), var(--primary-light)); }
.success-gradient::before { background: linear-gradient(90deg, var(--success), #34d399); }
.warning-gradient::before { background: linear-gradient(90deg, var(--warning), #fbbf24); }
.info-gradient::before { background: linear-gradient(90deg, var(--info), #22d3ee); }

.metric-card .d-flex {
  align-items: center;
}

.metric-icon {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  color: white;
  margin-right: 1rem;
}

.primary-gradient .metric-icon { background: var(--primary); }
.success-gradient .metric-icon { background: var(--success); }
.warning-gradient .metric-icon { background: var(--warning); }
.info-gradient .metric-icon { background: var(--info); }

.metric-number {
  font-size: 2rem;
  font-weight: 800;
  color: var(--text-primary);
  line-height: 1;
}

.metric-label {
  color: var(--text-secondary);
  font-weight: 500;
  margin: 0.25rem 0;
}

.metric-trend {
  font-size: 0.875rem;
  font-weight: 500;
}

/* Dashboard Cards */
.dashboard-card {
  background: white;
  border-radius: var(--radius-xl);
  box-shadow: var(--shadow-lg);
  margin-bottom: 1.5rem;
  border: none;
  overflow: hidden;
}

.dashboard-card .card-header {
  background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
  border-bottom: 1px solid var(--border-light);
  padding: 1.25rem 1.5rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.dashboard-card .card-title {
  margin: 0;
  font-weight: 700;
  color: var(--text-primary);
  font-size: 1.1rem;
}

.card-actions .btn {
  border-radius: var(--radius-md);
  padding: 0.375rem 0.75rem;
}

/* Activity List */
.activity-list {
  max-height: 400px;
  overflow-y: auto;
}

.activity-item {
  display: flex;
  align-items: center;
  padding: 1rem 1.5rem;
  border-bottom: 1px solid var(--border-light);
  transition: background-color 0.2s ease;
}

.activity-item:hover {
  background-color: var(--bg-secondary);
}

.activity-item:last-child {
  border-bottom: none;
}

.activity-icon {
  margin-right: 1rem;
}

.icon-bg {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 0.875rem;
}

.icon-bg.success { background: var(--success); }
.icon-bg.danger { background: var(--danger); }
.icon-bg.warning { background: var(--warning); }
.icon-bg.secondary { background: var(--secondary); }

.activity-content {
  flex: 1;
}

.activity-title {
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 0.25rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.activity-status .badge {
  font-size: 0.75rem;
  padding: 0.25rem 0.5rem;
}

.activity-details {
  color: var(--text-muted);
  font-size: 0.875rem;
}

/* Quick Stats */
.quick-stats {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.stat-item {
  display: flex;
  align-items: center;
  padding: 1rem;
  background: var(--bg-secondary);
  border-radius: var(--radius-lg);
  transition: all 0.2s ease;
}

.stat-item:hover {
  background: var(--bg-tertiary);
  transform: translateX(5px);
}

.stat-icon {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  margin-right: 1rem;
  font-size: 1.25rem;
}

.stat-value {
  font-size: 1.5rem;
  font-weight: 800;
  color: var(--text-primary);
  line-height: 1;
}

.stat-label {
  color: var(--text-secondary);
  font-size: 0.875rem;
  font-weight: 500;
}

/* Popular Scripts */
.popular-scripts {
  max-height: 300px;
  overflow-y: auto;
}

.script-item {
  display: flex;
  align-items: center;
  padding: 1rem 1.5rem;
  border-bottom: 1px solid var(--border-light);
  transition: background-color 0.2s ease;
}

.script-item:hover {
  background-color: var(--bg-secondary);
}

.script-item:last-child {
  border-bottom: none;
}

.script-icon {
  width: 40px;
  height: 40px;
  background: var(--primary);
  color: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 1rem;
  font-size: 0.875rem;
}

.script-info {
  flex: 1;
}

.script-name {
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 0.25rem;
}

.script-usage {
  color: var(--text-muted);
  font-size: 0.875rem;
}

.script-actions .btn {
  border-radius: var(--radius-md);
  padding: 0.25rem 0.5rem;
  font-size: 0.875rem;
}

/* Today's Tasks */
.today-tasks {
  max-height: 250px;
  overflow-y: auto;
}

.task-item {
  display: flex;
  align-items: center;
  padding: 1rem 1.5rem;
  border-bottom: 1px solid var(--border-light);
  transition: background-color 0.2s ease;
}

.task-item:hover {
  background-color: var(--bg-secondary);
}

.task-item:last-child {
  border-bottom: none;
}

.task-time {
  background: var(--primary);
  color: white;
  padding: 0.5rem 0.75rem;
  border-radius: var(--radius-md);
  font-weight: 600;
  font-size: 0.875rem;
  margin-right: 1rem;
  min-width: 60px;
  text-align: center;
}

.task-info {
  flex: 1;
}

.task-name {
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 0.25rem;
}

.task-details {
  color: var(--text-muted);
  font-size: 0.875rem;
}

.task-more {
  text-align: center;
  padding: 1rem;
  border-top: 1px solid var(--border-light);
}

.no-tasks {
  text-align: center;
  padding: 2rem 1rem;
}

.no-tasks i {
  font-size: 2rem;
  margin-bottom: 1rem;
}

/* Responsive Design */
@media (max-width: 768px) {
  .top-nav {
    padding: 1rem 0;
  }
  
  .welcome-text {
    font-size: 1.5rem;
  }
  
  .quick-actions {
    margin-top: 1rem;
    text-align: center;
  }
  
  .metric-card {
    padding: 1rem;
  }
  
  .metric-number {
    font-size: 1.5rem;
  }
  
  .metric-icon {
    width: 50px;
    height: 50px;
    font-size: 1.25rem;
  }
}

/* Scrollbar Styling */
.activity-list::-webkit-scrollbar,
.popular-scripts::-webkit-scrollbar,
.today-tasks::-webkit-scrollbar {
  width: 6px;
}

.activity-list::-webkit-scrollbar-track,
.popular-scripts::-webkit-scrollbar-track,
.today-tasks::-webkit-scrollbar-track {
  background: var(--bg-secondary);
}

.activity-list::-webkit-scrollbar-thumb,
.popular-scripts::-webkit-scrollbar-thumb,
.today-tasks::-webkit-scrollbar-thumb {
  background: var(--border-medium);
  border-radius: 3px;
}

.activity-list::-webkit-scrollbar-thumb:hover,
.popular-scripts::-webkit-scrollbar-thumb:hover,
.today-tasks::-webkit-scrollbar-thumb:hover {
  background: var(--border-dark);
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Activity Chart
  const activityCtx = document.getElementById('activityChart').getContext('2d');
  const activityChart = new Chart(activityCtx, {
    type: 'line',
    data: {
      labels: ['{{ (datetime.now() - timedelta(days=6)).strftime("%d.%m") }}', 
               '{{ (datetime.now() - timedelta(days=5)).strftime("%d.%m") }}', 
               '{{ (datetime.now() - timedelta(days=4)).strftime("%d.%m") }}', 
               '{{ (datetime.now() - timedelta(days=3)).strftime("%d.%m") }}', 
               '{{ (datetime.now() - timedelta(days=2)).strftime("%d.%m") }}', 
               '{{ (datetime.now() - timedelta(days=1)).strftime("%d.%m") }}', 
               '{{ datetime.now().strftime("%d.%m") }}'],
      datasets: [{
        label: 'Script Çalıştırma Sayısı',
        data: [{{ daily_executions|join(',') }}],
        borderColor: 'rgb(59, 130, 246)',
        backgroundColor: 'rgba(59, 130, 246, 0.1)',
        tension: 0.4,
        fill: true,
        pointBackgroundColor: 'rgb(59, 130, 246)',
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        pointRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: {
            color: 'rgba(0, 0, 0, 0.05)'
          }
        },
        x: {
          grid: {
            display: false
          }
        }
      }
    }
  });

  // Server Usage Chart
  const serverCtx = document.getElementById('serverUsageChart').getContext('2d');
  new Chart(serverCtx, {
    type: 'doughnut',
    data: {
      labels: [{% for server in server_usage %}'{{ server.name }}'{% if not loop.last %}, {% endif %}{% endfor %}],
      datasets: [{
        data: [{% for server in server_usage %}{{ server.count }}{% if not loop.last %}, {% endif %}{% endfor %}],
        backgroundColor: [
          '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
          '#06b6d4', '#84cc16', '#f97316', '#ec4899', '#6366f1'
        ],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 20,
            usePointStyle: true
          }
        }
      }
    }
  });

  // Script Types Chart
  const scriptCtx = document.getElementById('scriptTypesChart').getContext('2d');
  new Chart(scriptCtx, {
    type: 'doughnut',
    data: {
      labels: [{% for script_type in script_types %}'{{ script_type.script_type }}'{% if not loop.last %}, {% endif %}{% endfor %}],
      datasets: [{
        data: [{% for script_type in script_types %}{{ script_type.count }}{% if not loop.last %}, {% endif %}{% endfor %}],
        backgroundColor: [
          '#8b5cf6', '#06b6d4', '#84cc16', '#f97316', '#ec4899',
          '#6366f1', '#3b82f6', '#10b981', '#f59e0b', '#ef4444'
        ],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 20,
            usePointStyle: true
          }
        }
      }
    }
  });
});

function refreshChart() {
  location.reload();
}
</script>
{% endblock %} 